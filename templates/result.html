<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fefefe;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }

        #map {
            width: 100%;
            height: 300px;
            background-color: #dcdcdc;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .content {
            display: flex;
            gap: 20px;
        }

        .buttons, .categories, .results {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .buttons {
            width: 150px;
        }

        .buttons button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #007bff; /* 기본 파란색 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .buttons button.active {
            background-color: #28a745; /* 현재 초록색 */
        }

        .buttons button:selected {
            background-color: #ff8800; /* 선택된 주황색 */
        }

        .categories label {
            display: block;
            margin-bottom: 8px;
        }

        .results ul {
            list-style: none;
            padding: 0;
        }

        .results li {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map">[지도]</div>

        <div class="content">
            <!-- 관광 버튼 -->
            <div class="buttons" id="tourist-buttons"></div>

            <!-- 카테고리 -->
            <div class="categories" id="categories">
                <label>
                    <input type="checkbox" value="전체" checked onchange="handleCategoryChange(this)"> 전체
                </label>
            </div>

            <!-- 관광지 목록 -->
            <div class="results">
                <ul id="results"></ul>
            </div>
        </div>
    </div>

    <script>
        // 서버에서 전달된 값
        const city = "{{ city }}"; // Index.html에서 선택된 도시
        const count = {{ count }}; // Index.html에서 선택된 관광지 수
        let categories = []; // 카테고리 목록 (서버에서 가져오기)
        let activeCategories = ["전체"]; // 활성화된 카테고리 (기본값은 전체)
        let sites = []; // 관광지 목록 (서버에서 가져온 데이터)

        // 관광 버튼 생성
        function createTouristButtons() {
            const btnContainer = document.getElementById("tourist-buttons");
            for (let i = 1; i <= count; i++) {
                const button = document.createElement("button");
                button.innerText = `관광지 ${i}`;
                button.setAttribute("data-index", i);
                if (i === 1) button.classList.add("active"); // 기본 관광지 1 활성화
                button.onclick = () => handleTouristButtonClick(button);
                btnContainer.appendChild(button);
            }
        }

        // 관광 버튼 클릭 처리
        function handleTouristButtonClick(button) {
            const buttons = document.querySelectorAll(".buttons button");
            buttons.forEach(btn => btn.classList.remove("active"));
            button.classList.add("active");
        }

        // 카테고리 체크박스 생성
        function createCategoryCheckboxes() {
            fetch("/get_categories")
                .then(response => response.json())
                .then(data => {
                    categories = data.categories || [];
                    const categoryContainer = document.getElementById("categories");
                    categories.forEach(category => {
                        const label = document.createElement("label");
                        label.innerHTML = `
                            <input type="checkbox" value="${category}" onchange="handleCategoryChange(this)"> ${category}
                        `;
                        categoryContainer.appendChild(label);
                    });
                })
                .catch(err => console.error("카테고리 로드 실패:", err));
        }

        // 체크박스 변경 처리
 function handleCategoryChange(checkbox) {
    const allCheckbox = document.querySelector(".categories input[value='전체']");

    if (checkbox.value === "전체") {
        // "전체" 체크박스 처리
        if (checkbox.checked) {
            // "전체" 선택 시 다른 모든 체크박스 해제
            document.querySelectorAll(".categories input[type='checkbox']").forEach(cb => {
                if (cb.value !== "전체") cb.checked = false;
            });
            activeCategories = ["전체"];
        }
    } else {
        // 다른 카테고리 체크박스 처리
        if (checkbox.checked) {
            // "전체"가 선택되어 있으면 해제
            if (activeCategories.includes("전체")) {
                allCheckbox.checked = false;
                activeCategories = activeCategories.filter(cat => cat !== "전체");
            }
            activeCategories.push(checkbox.value);
        } else {
            // 체크 해제 시
            activeCategories = activeCategories.filter(cat => cat !== checkbox.value);

            // 모든 체크박스가 해제되면 "전체" 자동 선택
            if (activeCategories.length === 0) {
                allCheckbox.checked = true;
                activeCategories = ["전체"];
            }
        }
    }

    fetchTouristSites();
}

function fetchTouristSites() {
    if (!city) {
        console.error("City 값이 비어 있습니다!");
        return;
    }

    // "전체" 선택 시에도 categories=전체를 전달
    const queryCategories = `&categories=${encodeURIComponent(activeCategories.join(","))}`;

    const queryUrl = `/get_tourist_sites?city=${encodeURIComponent(city)}${queryCategories}`;
    console.log("요청 URL:", queryUrl);

    fetch(queryUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sites = data.sites || [];
                renderTouristSites();
            } else {
                console.error("서버 오류:", data.error);
            }
        })
        .catch(err => console.error("요청 실패:", err));
}


        // 관광지 목록 렌더링
        function renderTouristSites() {
            const resultContainer = document.getElementById("results");
            resultContainer.innerHTML = "";

            if (!sites || sites.length === 0) {
                resultContainer.innerHTML = "<li>관광지가 없습니다.</li>";
                return;
            }

            sites.forEach(site => {
                const li = document.createElement("li");
                li.innerText = `[${site.name}] (${site.category})`;
                resultContainer.appendChild(li);
            });
        }

        // 초기화
        function init() {
            createTouristButtons(); // 관광 버튼 생성
            createCategoryCheckboxes(); // 카테고리 생성
            fetchTouristSites(); // 관광지 데이터 가져오기
        }

        init();
    </script>
</body>
</html>