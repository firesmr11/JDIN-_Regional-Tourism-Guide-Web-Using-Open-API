<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검색 결과</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fefefe;
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }
        #map {
            width: 100%;
            height: 300px;
            background-color: #dcdcdc;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .content {
            display: flex;
            gap: 20px;
        }
        .buttons, .categories, .results {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .buttons {
            width: 150px;
        }
        .buttons button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .buttons button.active {
            background-color: #28a745;
        }
        .buttons button:hover {
            background-color: #0056b3;
        }
        .categories {
            flex: 1;
        }
        .categories label {
            display: block;
            margin-bottom: 8px;
        }
        .results {
            flex: 2;
        }
        .results ul {
            list-style: none;
            padding: 0;
        }
        .results li {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map">[지도]</div>

        <div class="content">
            <!-- 관광 버튼 -->
            <div class="buttons" id="tourist-buttons">
                <!-- 관광 버튼이 생성될 영역 -->
            </div>

            <!-- 카테고리 박스 -->
            <div class="categories" id="categories">
                <label><input type="checkbox" value="전체" checked onchange="handleCategoryChange(this)"> 전체</label>
                <!-- 카테고리 체크박스가 생성될 영역 -->
            </div>

            <!-- 관광지 목록 -->
            <div class="results">
                <ul id="results">
                    <!-- 관광지 목록이 생성될 영역 -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        const city = "{{ city }}"; // 전달받은 지역 이름 (예: "서울")
        const count = {{ count }}; // 전달받은 관광지 버튼 개수 (예: 5)
        let categories = []; // DB에서 받아올 카테고리 목록
        let activeCategories = ["전체"]; // 현재 활성화된 카테고리
        let sites = []; // 관광지 목록(DB에서 가져옴)

        // 관광 버튼 생성
        function createTouristButtons() {
            const btnContainer = document.getElementById('tourist-buttons');
            for (let i = 1; i <= count; i++) {
                const button = document.createElement('button');
                button.textContent = `관광지 ${i}`;
                if (i === 1) button.classList.add('active'); // 첫 번째 버튼 활성화
                button.onclick = () => handleButtonClick(button);
                btnContainer.appendChild(button);
            }
        }

        // 버튼 클릭 처리
        function handleButtonClick(button) {
            const buttons = document.querySelectorAll(".buttons button");
            buttons.forEach(btn => btn.classList.remove('active')); // 모든 버튼 비활성화
            button.classList.add('active'); // 현재 클릭한 버튼만 활성화
        }

        // 카테고리 체크박스 생성
        function createCategoryCheckboxes() {
            fetch('/get_categories') // DB에서 카테고리 목록 가져오기
                .then(response => response.json())
                .then(data => {
                    categories = data.categories; // 카테고리 목록
                    const categoryContainer = document.getElementById('categories');
                    categories.forEach(category => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="${category}" onchange="handleCategoryChange(this)"> ${category}`;
                        categoryContainer.appendChild(label);
                    });
                });
        }

        // 체크박스 변경 처리
        function handleCategoryChange(checkbox) {
            if (checkbox.value === "전체" && checkbox.checked) {
                activeCategories = ["전체"];
                const checkboxes = document.querySelectorAll(".categories input[type='checkbox']");
                checkboxes.forEach(cb => {
                    if (cb.value !== "전체") cb.checked = false;
                });
            } else {
                const allCheckbox = document.querySelector(".categories input[value='전체']");
                allCheckbox.checked = false;

                // 활성화된 카테고리 업데이트
                if (checkbox.checked) {
                    activeCategories.push(checkbox.value);
                } else {
                    activeCategories = activeCategories.filter(cat => cat !== checkbox.value);
                }
            }
            fetchTouristSites(); // 관광지 재검색
        }

        // 관광지 데이터 가져오기
        function fetchTouristSites() {
            // 카테고리 필터링
            const queryCategories = activeCategories.includes("전체") ? "" : `&categories=${activeCategories.join(",")}`;
            fetch(`/get_tourist_sites?city=${city}${queryCategories}`) // DB에서 관광지 데이터 가져오기
                .then(response => {
                    if (!response.ok) {
                        throw new Error("API 요청 실패");
                    }
                    return response.json();
                })
                .then(data => {
                    sites = data.sites; // 관광지 데이터 저장
                    renderTouristSites();
                })
                .catch(err => {
                    console.error("관광지 데이터를 불러오는 중 오류 발생:", err);
                    const resultContainer = document.getElementById('results');
                    resultContainer.innerHTML = "<li>데이터를 불러오지 못했습니다.</li>";
                });
        }

        // 관광지 목록 렌더링
        function renderTouristSites() {
            const resultContainer = document.getElementById('results');
            resultContainer.innerHTML = "";
            if (sites.length === 0) {
                resultContainer.innerHTML = "<li>관광지가 없습니다.</li>";
                return;
            }
            sites.forEach(site => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>[${site.name}] (${site.category})</span>
                `;
                resultContainer.appendChild(li);
            });
        }

        // 초기화
        function init() {
            createTouristButtons(); // 관광 버튼 생성
            createCategoryCheckboxes(); // 카테고리 생성
            fetchTouristSites(); // 관광지 로드
        }

        init(); // 프로그램 초기화
    </script>
</body>
</html>